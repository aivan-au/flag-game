<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Flag Game</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#1a1a2e" />
    <link rel="apple-touch-icon" href="assets/icons/icon-192.png" />
  </head>
  <body>
    <main class="app">
      <!-- START SCREEN -->
      <section id="start-screen" class="screen start-screen">
        <header class="screen-header start-header">
          <button class="btn btn-icon" id="options-btn" aria-label="Options">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
          </button>
          <label class="toggle-row header-toggle">
            <span class="toggle-label">Progression</span>
            <input type="checkbox" class="toggle-input" id="progression-toggle" />
            <span class="toggle-switch"></span>
          </label>
        </header>

        <div class="screen-content">
          <!-- Practice Mode: Pack Grid -->
          <div class="pack-grid" id="pack-options">
            <!-- Pack cards with images -->
            <button class="pack-card selected" data-pack="world">
              <img class="pack-img" src="assets/images/world.png" alt="World" />
              <span class="pack-label">World</span>
            </button>

            <button class="pack-card" data-pack="oceania">
                <img class="pack-img" src="assets/images/australia.png" alt="Oceania" />
                <span class="pack-label">Oceania</span>
            </button>

            <button class="pack-card" data-pack="europe">
                <img class="pack-img" src="assets/images/europe.png" alt="Europe" />
                <span class="pack-label">Europe</span>
            </button>

            <button class="pack-card" data-pack="asia">
                <img class="pack-img" src="assets/images/asia.png" alt="Asia" />
                <span class="pack-label">Asia</span>
            </button>

            <button class="pack-card" data-pack="africa">
              <img class="pack-img" src="assets/images/africa.png" alt="Africa" />
              <span class="pack-label">Africa</span>
            </button>

            <button class="pack-card" data-pack="southAmerica">
                <img class="pack-img" src="assets/images/south_america.png" alt="South America" />
                <span class="pack-label">S. America</span>
            </button>

            <button class="pack-card" data-pack="northAmerica">
              <img class="pack-img" src="assets/images/north_america.png" alt="North America" />
              <span class="pack-label">N. America</span>
            </button>

            <button class="pack-card" data-pack="worldFull">
              <img class="pack-img" src="assets/images/world_full.png" alt="All World" />
              <span class="pack-label">All World</span>
            </button>

            <button class="pack-card" data-pack="europeFull">
              <img class="pack-img" src="assets/images/europe_full.png" alt="All Europe" />
              <span class="pack-label">All Europe</span>
            </button>

            <button class="pack-card" data-pack="asiaFull">
              <img class="pack-img" src="assets/images/asia_full.png" alt="All Asia" />
              <span class="pack-label">All Asia</span>
            </button>

            <button class="pack-card" data-pack="africaFull">
              <img class="pack-img" src="assets/images/africa_full.png" alt="All Africa" />
              <span class="pack-label">All Africa</span>
            </button>
          </div>

          <!-- Challenge Mode: Progression Path (generated by JS) -->
          <div class="challenge-path hidden" id="challenge-path">
            <div class="path-container" id="path-container"></div>
          </div>
        </div>

        <footer class="screen-footer">
          <button class="btn btn-primary" id="start-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"></path>
              <path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"></path>
              <path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"></path>
              <path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"></path>
            </svg>
            Start
          </button>
          <div class="version-info">v1.3.0 | Developed by Ivan Smirnov and Claude Code</div>
        </footer>
      </section>

      <!-- GAME SCREEN -->
      <section id="game-screen" class="screen game-screen hidden">
        <header class="screen-header">
          <button class="btn btn-icon" id="exit-btn" aria-label="Exit">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 6 6 18"></path>
              <path d="m6 6 12 12"></path>
            </svg>
          </button>
          <div class="progress-bar" id="progress-bar">
            <!-- Progress pips generated dynamically -->
          </div>
        </header>

        <div class="screen-content game-layout">
          <div class="flag-container">
            <img id="flag" class="flag hidden" alt="Country flag" />
          </div>
          <div id="options" class="options-grid">
            <!-- Options generated dynamically -->
          </div>
        </div>

        <footer class="screen-footer">
          <button id="next-btn" class="btn btn-primary hidden">
            Next
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M5 12h14"></path>
              <path d="m12 5 7 7-7 7"></path>
            </svg>
          </button>
        </footer>
      </section>

      <!-- END SCREEN -->
      <section id="end-screen" class="screen end-screen hidden">
        <header class="screen-header">
          <button class="btn btn-icon" id="end-exit-btn" aria-label="Exit to menu">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 6 6 18"></path>
              <path d="m6 6 12 12"></path>
            </svg>
          </button>
        </header>

        <div class="screen-content">
          <div class="result-content">
            <img class="result-icon" src="assets/images/cup.png" alt="Result" />
            <h2 class="result-title">Congratulations!</h2>
            <div class="result-score">8 / 10</div>
          </div>
        </div>

        <footer class="screen-footer">
          <button class="btn btn-primary" id="play-again-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
              <path d="M21 3v5h-5"></path>
              <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
              <path d="M8 16H3v5"></path>
            </svg>
            Play Again
          </button>
        </footer>
      </section>

      <!-- OPTIONS MODAL -->
      <div id="options-modal" class="modal hidden">
        <div class="modal-content">
          <div class="modal-header">
            <h2>Options</h2>
            <button class="btn btn-icon" id="close-modal" aria-label="Close">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 6 6 18"></path>
                <path d="m6 6 12 12"></path>
              </svg>
            </button>
          </div>

          <div class="options-list">
            <label class="toggle-row">
              <span class="toggle-label">Music</span>
              <input type="checkbox" class="toggle-input" id="music-toggle" checked />
              <span class="toggle-switch"></span>
            </label>

            <label class="toggle-row">
              <span class="toggle-label">Voice</span>
              <input type="checkbox" class="toggle-input" id="voice-toggle" checked />
              <span class="toggle-switch"></span>
            </label>

            <label class="toggle-row">
              <span class="toggle-label">Auto-advance</span>
              <input type="checkbox" class="toggle-input" id="auto-advance-toggle" />
              <span class="toggle-switch"></span>
            </label>
          </div>

          <div class="option-group">
            <span class="option-group-label">Questions per round</span>
            <div class="segment-control" id="questions-select">
              <button class="segment-btn" data-value="5">5</button>
              <button class="segment-btn selected" data-value="10">10</button>
              <button class="segment-btn" data-value="20">20</button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      // Options modal
      document.getElementById('options-btn').addEventListener('click', () => {
        document.getElementById('options-modal').classList.remove('hidden');
      });
      document.getElementById('close-modal').addEventListener('click', () => {
        document.getElementById('options-modal').classList.add('hidden');
      });

      // Progression mode toggle
      document.getElementById('progression-toggle').addEventListener('change', (e) => {
        const packGrid = document.getElementById('pack-options');
        const challengePath = document.getElementById('challenge-path');
        const startBtn = document.getElementById('start-btn');

        if (e.target.checked) {
          packGrid.classList.add('hidden');
          challengePath.classList.remove('hidden');
          startBtn.classList.add('hidden');
        } else {
          packGrid.classList.remove('hidden');
          challengePath.classList.add('hidden');
          startBtn.classList.remove('hidden');
        }
      });
    </script>

    <!-- Game scripts -->
    <script src="countries.js"></script>
    <script src="challenges.js"></script>
    <script src="app.js"></script>

    <!-- Progression path rendering (uses hardcoded progressionChallenges) -->
    <script>
      (function() {
        const GROUP_SIZE = 5;
        const OFFSET = 60;
        const GROUP_OFFSETS_RIGHT = [0, OFFSET, -OFFSET, OFFSET, 0];
        const GROUP_OFFSETS_LEFT  = [0, -OFFSET, OFFSET, -OFFSET, 0];

        const lockSvg = '<svg class="path-lock" width="14" height="14" viewBox="0 0 24 24" fill="var(--color-muted)" stroke="none"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4" fill="none" stroke="var(--color-muted)" stroke-width="2" stroke-linecap="round"/></svg>';

        function makeConnector(fromX, toX) {
          const svgFrom = 60 + (fromX / OFFSET) * 40;
          const svgTo = 60 + (toX / OFFSET) * 40;
          const cpX = (svgFrom + svgTo) / 2;
          return `<div class="path-connector"><svg class="path-line" viewBox="0 0 120 40" preserveAspectRatio="none"><path d="M${svgFrom} 0 Q${cpX} 20 ${svgTo} 40" stroke="var(--color-border)" stroke-width="3" fill="none" stroke-linecap="round"/></svg></div>`;
        }

        const container = document.getElementById('path-container');

        function renderPath() {
          const completed = parseInt(localStorage.getItem('progressionCompleted') || '0', 10);
          let html = '';

          progressionChallenges.forEach((ch, i) => {
            const num = i + 1;
            const isReview = ch.type === 'review';
            const groupIndex = Math.floor(i / GROUP_SIZE);
            const posInGroup = i % GROUP_SIZE;
            const offsets = groupIndex % 2 === 0 ? GROUP_OFFSETS_RIGHT : GROUP_OFFSETS_LEFT;
            const isLastChallenge = i === progressionChallenges.length - 1;
            const thisOffset = (isLastChallenge && isReview) ? 0 : offsets[posInGroup];

            let nodeState;
            if (i < completed) nodeState = 'completed';
            else if (i === completed) nodeState = 'unlocked';
            else nodeState = 'locked';

            if (i > 0 && posInGroup === 0) {
              html += makeConnector(0, 0);
            } else if (i > 0) {
              const prevGroupIndex = Math.floor((i - 1) / GROUP_SIZE);
              const prevOffsets = prevGroupIndex % 2 === 0 ? GROUP_OFFSETS_RIGHT : GROUP_OFFSETS_LEFT;
              const prevIsLast = (i - 1) === progressionChallenges.length - 1;
              const prevChIsReview = progressionChallenges[i - 1].type === 'review';
              const prevOffset = (prevIsLast && prevChIsReview) ? 0 : prevOffsets[(i - 1) % GROUP_SIZE];
              html += makeConnector(prevOffset, thisOffset);
            }

            const extras = [];
            if (nodeState === 'locked') extras.push(lockSvg);

            html += `<div class="path-level ${nodeState}${isReview ? ' review' : ''}" data-level="${num}" style="--offset: ${thisOffset}px">`;
            html += `<div class="path-node">`;
            html += `<span class="path-node-number">${num}</span>`;
            html += extras.join('');
            html += `</div>`;
            html += `</div>`;
          });

          container.innerHTML = html;
        }

        // Initial render
        renderPath();

        // Re-render when returning to start screen so progress is reflected
        window.renderProgressionPath = renderPath;

        container.addEventListener('click', (e) => {
          const level = e.target.closest('.path-level');
          if (!level) return;
          if (level.classList.contains('locked')) return;

          const levelNum = parseInt(level.dataset.level, 10);
          window.startProgressionChallenge(levelNum - 1);
        });
      })();
    </script>

    <!-- Service Worker Registration -->
    <script>
      if ('serviceWorker' in navigator) {
        const devMode = new URLSearchParams(location.search).has('dev');
        if (devMode) {
          // Unregister service worker and clear caches in dev mode
          navigator.serviceWorker.getRegistrations().then(registrations => {
            registrations.forEach(r => r.unregister());
          });
          caches.keys().then(names => {
            names.forEach(name => caches.delete(name));
          });
          console.log('Dev mode: Service worker unregistered, caches cleared');
        } else {
          navigator.serviceWorker.register('./sw.js');
        }
      }
    </script>
  </body>
</html>
